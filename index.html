<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finc v1.1 | Controle Financeiro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Manrope', 'system-ui', 'sans-serif'],
            display: ['Playfair Display', 'serif'],
          },
          colors: {
            primary: '#7c3aed',
            accent: '#f97316',
            mint: '#22c55e',
            rose: '#f43f5e',
          },
        },
      },
    };
  </script>
  <style>
    body {
      background: radial-gradient(circle at 20% 20%, rgba(244, 63, 94, 0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(124, 58, 237, 0.18), transparent 30%),
                  #0f172a;
    }
    .glass {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body class="text-slate-100 flex justify-center min-h-screen">
  <div id="root" class="w-full max-w-3xl px-4 py-6"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const palette = ["#7c3aed", "#f97316", "#22c55e", "#ec4899", "#06b6d4", "#f59e0b", "#ef4444", "#8b5cf6"];

    const defaultMonth = {
      label: "Maio 2026",
      incomes: [
        { label: "Salário 1", value: 6000 },
        { label: "Salário 2", value: 3000 },
        { label: "Outros", value: 900 },
      ],
      expenses: [
        { label: "Cartão (fechamento)", category: "Cartão", planned: 1200, actual: 1400, paid: true },
        { label: "Internet + luz", category: "Contas fixas", planned: 450, actual: 520, paid: true },
        { label: "Streaming", category: "Uso pessoal", planned: 90, actual: 120, paid: false },
        { label: "Almoço fora", category: "Uso pessoal", planned: 120, actual: 140, paid: false },
        { label: "Investimento", category: "Investimento", planned: 500, actual: 500, paid: true },
        { label: "Reserva emergência", category: "Emergência", planned: 0, actual: 100, paid: false },
      ],
      categories: [
        { label: "Cartão", planned: 1200, color: "#7c3aed" },
        { label: "Contas fixas", planned: 900, color: "#f97316" },
        { label: "Uso pessoal", planned: 400, color: "#22c55e" },
        { label: "Investimento", planned: 500, color: "#ec4899" },
        { label: "Emergência", planned: 100, color: "#06b6d4" },
      ],
    };

    const loadState = () => {
      try {
        const saved = localStorage.getItem("finc-v1");
        if (saved) return JSON.parse(saved);
      } catch (err) {
        console.warn("LocalStorage não disponível", err);
      }
      return { currentMonth: "2026-05", months: { "2026-05": defaultMonth } };
    };

    const currency = (value) =>
      (Number(value) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL", minimumFractionDigits: 0 });

    const sum = (items, key) => items.reduce((acc, item) => acc + (Number(item[key]) || 0), 0);

    const ChartDonut = ({ data, labels, colors }) => {
      const ref = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!ref.current) return;
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ref.current, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 8, cutout: "65%" }],
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#0f172a",
                padding: 10,
                callbacks: { label: (ctx) => `${ctx.label}: ${currency(ctx.raw)}` },
              },
            },
          },
        });
        return () => chartRef.current?.destroy();
      }, [data, labels, colors]);

      return <canvas ref={ref} height="280" />;
    };

    const Input = (props) => (
      <input
        {...props}
        className={
          "w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-semibold text-white placeholder-white/50 focus:border-accent focus:ring-2 focus:ring-accent/60 " +
          (props.className || "")
        }
      />
    );

    const Select = ({ options, ...rest }) => (
      <select
        {...rest}
        className="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-semibold text-white focus:border-accent focus:ring-2 focus:ring-accent/60"
      >
        {options.map((opt) => (
          <option key={opt.value} value={opt.value} className="bg-slate-900">
            {opt.label}
          </option>
        ))}
      </select>
    );

    const App = () => {
      const [state, setState] = useState(loadState);
      const [tab, setTab] = useState("expense"); // expense | income
      const [fabOpen, setFabOpen] = useState(false);

      useEffect(() => {
        localStorage.setItem("finc-v1", JSON.stringify(state));
      }, [state]);

      const month = state.months[state.currentMonth];

      const totals = useMemo(() => {
        const incomes = sum(month.incomes, "value");
        const expenses = sum(month.expenses, "actual");
        const planned = sum(month.categories, "planned");
        return { incomes, expenses, planned, balance: incomes - expenses };
      }, [month]);

      const groupedCategories = useMemo(() => {
        const base = month.categories.map((c, i) => ({
          label: c.label,
          planned: Number(c.planned) || 0,
          color: c.color || palette[i % palette.length],
          actual: 0,
        }));
        const byLabel = Object.fromEntries(base.map((c) => [c.label, c]));
        month.expenses.forEach((e) => {
          if (!byLabel[e.category]) {
            const newCat = {
              label: e.category,
              planned: 0,
              color: palette[(Object.keys(byLabel).length + 1) % palette.length],
              actual: 0,
            };
            byLabel[e.category] = newCat;
          }
          byLabel[e.category].actual += Number(e.actual) || 0;
        });
        return Object.values(byLabel);
      }, [month]);

      const handleIncome = (event) => {
        event.preventDefault();
        const form = new FormData(event.target);
        const label = form.get("label").trim();
        const value = Number(form.get("value")) || 0;
        if (!label) return;
        setState((prev) => {
          const next = { ...prev };
          const m = { ...next.months[next.currentMonth] };
          m.incomes = [...m.incomes, { label, value }];
          next.months[next.currentMonth] = m;
          return next;
        });
        event.target.reset();
        setFabOpen(false);
      };

      const handleExpense = (event) => {
        event.preventDefault();
        const form = new FormData(event.target);
        const label = form.get("label").trim();
        const category = form.get("category").trim() || "Outro";
        const planned = Number(form.get("planned")) || 0;
        const actual = Number(form.get("actual")) || 0;
        const paid = form.get("paid") === "on";
        if (!label) return;
        setState((prev) => {
          const next = { ...prev };
          const m = { ...next.months[next.currentMonth] };
          m.expenses = [...m.expenses, { label, category, planned, actual, paid }];
          next.months[next.currentMonth] = m;
          return next;
        });
        event.target.reset();
        setFabOpen(false);
      };

      const togglePaid = (idx) => {
        setState((prev) => {
          const next = { ...prev };
          const m = { ...next.months[next.currentMonth] };
          m.expenses = m.expenses.map((e, i) => (i === idx ? { ...e, paid: !e.paid } : e));
          next.months[next.currentMonth] = m;
          return next;
        });
      };

      const newMonth = () => {
        const label = prompt("Nome do mês (ex: Junho 2026)");
        if (!label) return;
        const key = Date.now().toString();
        setState((prev) => ({
          ...prev,
          currentMonth: key,
          months: {
            ...prev.months,
            [key]: { ...defaultMonth, label, incomes: [], expenses: [], categories: defaultMonth.categories },
          },
        }));
      };

      const exportCSV = () => {
        const lines = [];
        lines.push(`Mês,${month.label}`);
        lines.push("");
        lines.push("Entradas");
        lines.push("Descrição,Valor");
        month.incomes.forEach((i) => lines.push(`${i.label},${i.value}`));
        lines.push("");
        lines.push("Categorias (orçado x real)");
        lines.push("Categoria,Orçado,Real");
        groupedCategories.forEach((c) => lines.push(`${c.label},${c.planned},${c.actual}`));
        lines.push("");
        lines.push("Gastos detalhados");
        lines.push("Descrição,Categoria,Orçado,Real,Pago");
        month.expenses.forEach((e) => lines.push(`${e.label},${e.category},${e.planned},${e.actual},${e.paid ? "Sim" : "Não"}`));
        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${month.label.replace(/\s+/g, "_")}.csv`;
        link.click();
      };

      const exportPDF = () => window.print();

      return (
        <div className="space-y-4 pb-20">
          <header className="glass rounded-2xl p-4 shadow-xl">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs uppercase tracking-[0.15em] text-white/60">Finc v1.1</p>
                <h1 className="text-2xl font-display font-semibold leading-tight">Dashboard financeiro</h1>
              </div>
              <span className="rounded-full bg-white/10 px-3 py-1 text-xs font-bold text-white">Saldo: {currency(totals.balance)}</span>
            </div>
            <div className="mt-3 grid gap-3 sm:grid-cols-3">
              <div className="glass rounded-xl p-3">
                <p className="text-xs uppercase tracking-[0.15em] text-white/60">Entradas</p>
                <p className="text-xl font-bold text-mint">{currency(totals.incomes)}</p>
              </div>
              <div className="glass rounded-xl p-3">
                <p className="text-xs uppercase tracking-[0.15em] text-white/60">Gasto real</p>
                <p className="text-xl font-bold text-rose">{currency(totals.expenses)}</p>
              </div>
              <div className="glass rounded-xl p-3">
                <p className="text-xs uppercase tracking-[0.15em] text-white/60">Orçado</p>
                <p className="text-xl font-bold text-accent">{currency(totals.planned)}</p>
              </div>
            </div>
            <div className="mt-4 grid gap-2 sm:grid-cols-4">
              <Select
                options={Object.entries(state.months).map(([key, m]) => ({ value: key, label: m.label }))}
                value={state.currentMonth}
                onChange={(e) => setState((prev) => ({ ...prev, currentMonth: e.target.value }))}
              />
              <button onClick={newMonth} className="glass rounded-xl px-3 py-2 text-sm font-bold text-white hover:bg-white/10">
                + Novo mês
              </button>
              <button onClick={exportCSV} className="glass rounded-xl px-3 py-2 text-sm font-bold text-white hover:bg-white/10">
                Exportar CSV
              </button>
              <button onClick={exportPDF} className="glass rounded-xl px-3 py-2 text-sm font-bold text-white hover:bg-white/10">
                Exportar PDF
              </button>
            </div>
          </header>

          <section className="grid gap-4 md:grid-cols-2">
            <div className="glass rounded-2xl p-4 shadow-xl">
              <div className="flex items-center justify-between">
                <h2 className="text-lg font-bold">Distribuição de gastos</h2>
                <span className="text-xs font-bold text-white/70">Visão mensal</span>
              </div>
              <div className="mt-4">
                <ChartDonut
                  data={groupedCategories.map((c) => c.actual)}
                  labels={groupedCategories.map((c) => c.label)}
                  colors={groupedCategories.map((c) => c.color)}
                />
              </div>
              <div className="mt-4 grid gap-2 sm:grid-cols-2">
                {groupedCategories.map((c) => (
                  <div key={c.label} className="flex items-center gap-3 rounded-xl bg-white/5 px-3 py-2">
                    <span className="h-3 w-3 rounded-full" style={{ background: c.color }} />
                    <div className="flex-1">
                      <p className="text-sm font-semibold">{c.label}</p>
                      <p className="text-xs text-white/60">
                        {currency(c.actual)} · {totals.expenses ? Math.round((c.actual / totals.expenses) * 100) : 0}%
                      </p>
                    </div>
                    <span className="text-xs font-bold text-white/70">{currency(c.planned)}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="glass rounded-2xl p-4 shadow-xl space-y-3">
              <div className="flex items-center justify-between">
                <h2 className="text-lg font-bold">Resumo rápido</h2>
                <span className="text-xs font-bold text-white/70">Checklist</span>
              </div>
              <div className="space-y-2">
                {month.expenses.map((e, idx) => (
                  <div key={idx} className="flex items-center gap-3 rounded-xl bg-white/5 px-3 py-2">
                    <input
                      type="checkbox"
                      checked={e.paid}
                      onChange={() => togglePaid(idx)}
                      className="h-5 w-5 rounded border-white/30 bg-transparent text-accent focus:ring-accent"
                    />
                    <div className="flex-1">
                      <p className="text-sm font-semibold">{e.label}</p>
                      <p className="text-xs text-white/60">{e.category} · Orçado {currency(e.planned)}</p>
                    </div>
                    <span className="text-sm font-bold text-white/80">{currency(e.actual)}</span>
                  </div>
                ))}
              </div>
            </div>
          </section>

          <section className="glass rounded-2xl p-4 shadow-xl">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">Entradas</h2>
              <span className="text-xs font-bold text-white/70">Total {currency(totals.incomes)}</span>
            </div>
            <div className="mt-2 space-y-2">
              {month.incomes.map((inc, idx) => (
                <div key={idx} className="flex items-center justify-between rounded-xl bg-white/5 px-3 py-2">
                  <div>
                    <p className="text-sm font-semibold">{inc.label}</p>
                    <p className="text-xs text-white/60">Entrada</p>
                  </div>
                  <span className="text-sm font-bold text-mint">{currency(inc.value)}</span>
                </div>
              ))}
            </div>
          </section>

          <section className="glass rounded-2xl p-4 shadow-xl">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">Gastos detalhados</h2>
              <span className="text-xs font-bold text-white/70">Total {currency(totals.expenses)}</span>
            </div>
            <div className="mt-2 space-y-2">
              {month.expenses.map((exp, idx) => (
                <div key={idx} className="flex items-center justify-between rounded-xl bg-white/5 px-3 py-2">
                  <div>
                    <p className="text-sm font-semibold">{exp.label}</p>
                    <p className="text-xs text-white/60">{exp.category}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-sm font-bold text-white/80">{currency(exp.actual)}</p>
                    <p className="text-xs text-white/50">Orçado {currency(exp.planned)}</p>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {fabOpen && (
            <div className="fixed inset-0 z-20 bg-black/50" onClick={() => setFabOpen(false)}></div>
          )}

          <div className={"fixed inset-x-0 bottom-0 z-30 mx-auto w-full max-w-3xl px-4 pb-4 transition " + (fabOpen ? "translate-y-0" : "translate-y-[72px]")}>
            <div className="glass rounded-2xl p-4 shadow-2xl">
              <div className="flex items-center justify-between">
                <div className="flex gap-2 rounded-full bg-white/10 p-1">
                  <button
                    onClick={() => setTab("expense")}
                    className={"rounded-full px-3 py-1 text-sm font-bold " + (tab === "expense" ? "bg-white text-slate-900" : "text-white/80")}
                  >
                    Gasto
                  </button>
                  <button
                    onClick={() => setTab("income")}
                    className={"rounded-full px-3 py-1 text-sm font-bold " + (tab === "income" ? "bg-white text-slate-900" : "text-white/80")}
                  >
                    Entrada
                  </button>
                </div>
                <button onClick={() => setFabOpen((v) => !v)} className="grid h-12 w-12 place-items-center rounded-full bg-accent text-slate-900 shadow-lg">
                  {fabOpen ? "×" : "+"}
                </button>
              </div>

              {fabOpen && (
                <div className="mt-3">
                  {tab === "expense" ? (
                    <form className="grid gap-2 sm:grid-cols-2" onSubmit={handleExpense}>
                      <Input name="label" placeholder="Descrição do gasto" required />
                      <Input name="category" placeholder="Categoria (ex: Cartão)" />
                      <Input name="planned" placeholder="Orçado" type="number" min="0" step="10" />
                      <Input name="actual" placeholder="Real" type="number" min="0" step="10" required />
                      <label className="flex items-center gap-2 text-sm font-semibold text-white/80">
                        <input type="checkbox" name="paid" className="h-4 w-4 rounded border-white/40 bg-transparent text-accent focus:ring-accent" />
                        Pago
                      </label>
                      <button className="col-span-full rounded-xl bg-accent px-4 py-2 text-sm font-extrabold text-slate-900 shadow-lg hover:opacity-95">
                        Salvar gasto
                      </button>
                    </form>
                  ) : (
                    <form className="grid gap-2 sm:grid-cols-2" onSubmit={handleIncome}>
                      <Input name="label" placeholder="Descrição da entrada" required />
                      <Input name="value" placeholder="Valor" type="number" min="0" step="10" required />
                      <button className="col-span-full rounded-xl bg-mint px-4 py-2 text-sm font-extrabold text-slate-900 shadow-lg hover:opacity-95">
                        Salvar entrada
                      </button>
                    </form>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
